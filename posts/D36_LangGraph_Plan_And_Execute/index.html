

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="mztchaoqun">
  <meta name="keywords" content="hexo,theme,fluid,material,material-design,blog">
  
    <meta name="description" content="一、Plan-and-Execute Agents Plan-and-execute 架构：这是一种将规划（plan）和执行（execute）分离的智能代理设计模式。 LangGraph提出了三种 Plan-and-Execute 风格的 Agent，并且相对于传统ReAct风格的Agnet做了很多改进。  速度提升：无需在每个动作后咨询更大的代理，子任务可以独立执行，减少对大型语言模型（LLM）">
<meta property="og:type" content="article">
<meta property="og:title" content="LangGraph(五)——Plan-and-Execute Agents">
<meta property="og:url" content="https://mztchaoqun.com.cn/posts/D36_LangGraph_Plan_And_Execute/index.html">
<meta property="og:site_name" content="Suny的文章">
<meta property="og:description" content="一、Plan-and-Execute Agents Plan-and-execute 架构：这是一种将规划（plan）和执行（execute）分离的智能代理设计模式。 LangGraph提出了三种 Plan-and-Execute 风格的 Agent，并且相对于传统ReAct风格的Agnet做了很多改进。  速度提升：无需在每个动作后咨询更大的代理，子任务可以独立执行，减少对大型语言模型（LLM）">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://mztchaoqun.com.cn/images/Plan_Execute_Agents.jpg">
<meta property="article:published_time" content="2024-09-07T15:58:11.000Z">
<meta property="article:modified_time" content="2026-02-27T13:41:45.272Z">
<meta property="article:author" content="mztchaoqun">
<meta property="article:tag" content="Agent">
<meta property="article:tag" content="LLM">
<meta property="article:tag" content="LLM学习笔记">
<meta property="article:tag" content="LangGraph">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://mztchaoqun.com.cn/images/Plan_Execute_Agents.jpg">
  
  
  
  <title>LangGraph(五)——Plan-and-Execute Agents - Suny的文章</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"mztchaoqun.com.cn","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 8.1.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Suny的文章</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/it-tools/" target="_self">
                <i class="iconfont icon-briefcase"></i>
                <span>it-tools</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-books"></i>
                <span>文档</span>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="https://hexo.fluid-dev.com/docs/start/" target="_self">
                    
                    <span>安装主题</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://hexo.fluid-dev.com/docs/guide/" target="_self">
                    
                    <span>配置指南</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://hexo.fluid-dev.com/docs/icon/" target="_self">
                    
                    <span>图标用法</span>
                  </a>
                
              </div>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/images/post_banner.webp') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="LangGraph(五)——Plan-and-Execute Agents"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-09-07 23:58" pubdate>
          2024年9月7日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          6.1k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          51 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">LangGraph(五)——Plan-and-Execute Agents</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="一plan-and-execute-agents">一、Plan-and-Execute Agents</h2>
<p><strong>Plan-and-execute
架构</strong>：这是一种将规划（plan）和执行（execute）分离的智能代理设计模式。</p>
<p>LangGraph提出了三种 Plan-and-Execute 风格的
Agent，并且相对于传统ReAct风格的Agnet做了很多改进。</p>
<ol type="1">
<li><strong>速度提升</strong>：无需在每个动作后咨询更大的代理，子任务可以独立执行，减少对大型语言模型（LLM）的调用。</li>
<li><strong>成本节约</strong>：如果子任务调用LLM，通常可以使用更小的、特定领域的模型，而大型模型仅用于（重新）规划步骤和生成最终响应。</li>
<li><strong>性能提升</strong>：通过强制规划者明确“思考”完成整个任务所需的所有步骤，可以提高任务完成率和质量。</li>
</ol>
<h3 id="背景">1.1 背景</h3>
<p>LLM Angen通常有以下主要步骤：</p>
<ol type="1">
<li><strong>建议<code>action</code></strong>：LLM生成文本直接响应用户或传递给函数。</li>
<li><strong>执行<code>action</code></strong>：代码调用其他软件执行查询数据库或调用API等操作。</li>
<li><strong>观察</strong>：根据工具调用的响应，调用另一个函数或响应用户。</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://arxiv.org/abs/2210.03629">ReAct</a> Agent
是一个典型的设计，使用重复的思考、行动、观察循环来提示语言模型:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">Thought: I should call Search() to see the current score of the game.<br>Act: Search(&quot;What is the current score of game X?&quot;)<br>Observation: The current score is 24-21<br>... (repeat N times)<br></code></pre></td></tr></table></figure>
<p>其利用了思想链(<a
target="_blank" rel="noopener" href="https://arxiv.org/abs/2201.11903">Chain-of-thought</a>)提示，让每一步做出单一的操作选择。虽然这对于简单的任务可能有效，但它有几个主要缺点：</p>
<ol type="1">
<li>每次工具调用都需要一个 LLM 调用。</li>
<li>LLM 一次仅计划 1
个子问题。这可能会导致不是最优过程，因为它不会强制“推理”整个任务。</li>
</ol>
<p>克服这两个缺点的一种方法是通过明确的规划步骤。下面是我们在 LangGraph
中实现的两个这样的设计。</p>
<h3 id="计划与执行plan-and-execute架构">1.2
计划与执行（Plan-and-Execute）架构</h3>
<p><img src="/images/plan-and-execute.png" srcset="/img/loading.gif" lazyload /></p>
<p>这个想法很大程度上是受到 <a
target="_blank" rel="noopener" href="https://github.com/yoheinakajima/babyagi">BabyAGI</a> 和后来的《<a
target="_blank" rel="noopener" href="https://arxiv.org/pdf/2305.04091.pdf">Plan-and-Solve
Prompting</a>》论文的启发</p>
<p><strong>planner</strong>：提示LLM生成完成大型任务的多步骤计划。
<strong>Executor</strong>：接受用户查询和计划中的步骤，并调用一个或多个工具来完成任务。</p>
<p>执行完成后，Agent
再次被调用，使用重新规划提示，决定是完成响应还是生成后续计划。</p>
<p>这种Agent设计让我们不必再将整个大Plan直接调用LLM，而是分成多个小的Plan。但是它仍然受到串行工具调用的限制，并为每个任务都得LLM，因为它不支持变量分配。</p>

    <div class="fold">
      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-d285e4d6" role="button" aria-expanded="false" aria-controls="collapse-d285e4d6">
        <div class="fold-arrow">▶</div>LangGraph代码示例
      </div>
      <div class="fold-collapse collapse" id="collapse-d285e4d6">
        <div class="fold-content">
          <p><strong>定义模型和工具</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_community.tools.tavily_search <span class="hljs-keyword">import</span> TavilySearchResults<br><span class="hljs-keyword">from</span> langchain <span class="hljs-keyword">import</span> hub<br><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_openai_functions_agent<br><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI<br><span class="hljs-keyword">from</span> langgraph.prebuilt <span class="hljs-keyword">import</span> create_agent_executor<br><br>tools = [TavilySearchResults(max_results=<span class="hljs-number">3</span>)]<br><br><span class="hljs-comment"># prompt</span><br>prompt = hub.pull(<span class="hljs-string">&quot;hwchase17/openai-functions-agent&quot;</span>)<br><br><span class="hljs-comment"># LLM</span><br>llm = ChatOpenAI(model=<span class="hljs-string">&quot;gpt-4-turbo&quot;</span>)<br><br><span class="hljs-comment"># Agent</span><br>agent_runnable = create_openai_functions_agent(llm, tools, prompt)<br><br>agent_executor = create_agent_executor(agent_runnable, tools)<br></code></pre></td></tr></table></figure><p><strong>定义state</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_core.pydantic_v1 <span class="hljs-keyword">import</span> BaseModel, Field<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Tuple</span>, Annotated, TypedDict<br><span class="hljs-keyword">import</span> operator<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PlanExecute</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):<br>    <span class="hljs-built_in">input</span>: <span class="hljs-built_in">str</span><br>    plan: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]<br>    past_steps: Annotated[<span class="hljs-type">List</span>[<span class="hljs-type">Tuple</span>], operator.add]<br>    response: <span class="hljs-built_in">str</span><br></code></pre></td></tr></table></figure><p><strong>定义Planner</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_core.pydantic_v1 <span class="hljs-keyword">import</span> BaseModel<br><span class="hljs-keyword">from</span> langchain.chains.openai_functions <span class="hljs-keyword">import</span> create_structured_output_runnable<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Plan</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Plan to follow in future&quot;&quot;&quot;</span><br><br>    steps: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>] = Field(<br>        description=<span class="hljs-string">&quot;different steps to follow, should be in sorted order&quot;</span><br>    )<br>        <br><br><br>planner_prompt = ChatPromptTemplate.from_template(<br>    <span class="hljs-string">&quot;&quot;&quot;For the given objective, come up with a simple step by step plan. \</span><br><span class="hljs-string">This plan should involve individual tasks, that if executed correctly will yield the correct answer. Do not add any superfluous steps. \</span><br><span class="hljs-string">The result of the final step should be the final answer. Make sure that each step has all the information needed - do not skip steps.</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#123;objective&#125;&quot;&quot;&quot;</span><br>)<br><br>planner = create_structured_output_runnable(<br>    Plan, ChatOpenAI(model=<span class="hljs-string">&quot;gpt-4-turbo&quot;</span>, temperature=<span class="hljs-number">0</span>), planner_prompt<br>)<br></code></pre></td></tr></table></figure><p><strong>定义Re-Plannner</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.chains.openai_functions <span class="hljs-keyword">import</span> create_openai_fn_runnable<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Response</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Response to user.&quot;&quot;&quot;</span><br><br>    response: <span class="hljs-built_in">str</span><br><br><br>replanner_prompt = ChatPromptTemplate.from_template(<br>    <span class="hljs-string">&quot;&quot;&quot;For the given objective, come up with a simple step by step plan. \</span><br><span class="hljs-string">This plan should involve individual tasks, that if executed correctly will yield the correct answer. Do not add any superfluous steps. \</span><br><span class="hljs-string">The result of the final step should be the final answer. Make sure that each step has all the information needed - do not skip steps.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Your objective was this:</span><br><span class="hljs-string">&#123;input&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">Your original plan was this:</span><br><span class="hljs-string">&#123;plan&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">You have currently done the follow steps:</span><br><span class="hljs-string">&#123;past_steps&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">Update your plan accordingly. If no more steps are needed and you can return to the user, then respond with that. Otherwise, fill out the plan. Only add steps to the plan that still NEED to be done. Do not return previously done steps as part of the plan.&quot;&quot;&quot;</span><br>)<br><br><br>replanner = create_openai_fn_runnable(<br>    [Plan, Response],<br>    ChatOpenAI(model=<span class="hljs-string">&quot;gpt-4-turbo&quot;</span>, temperature=<span class="hljs-number">0</span>),<br>    replanner_prompt,<br>)<br></code></pre></td></tr></table></figure><p><strong>定义Nodes</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_step</span>(<span class="hljs-params">state: PlanExecute</span>):<br>    task = state[<span class="hljs-string">&quot;plan&quot;</span>][<span class="hljs-number">0</span>]<br>    agent_response = <span class="hljs-keyword">await</span> agent_executor.ainvoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: task, <span class="hljs-string">&quot;chat_history&quot;</span>: []&#125;)<br>    <span class="hljs-keyword">return</span> &#123;<br>        <span class="hljs-string">&quot;past_steps&quot;</span>: (task, agent_response[<span class="hljs-string">&quot;agent_outcome&quot;</span>].return_values[<span class="hljs-string">&quot;output&quot;</span>])<br>    &#125;<br><br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">plan_step</span>(<span class="hljs-params">state: PlanExecute</span>):<br>    plan = <span class="hljs-keyword">await</span> planner.ainvoke(&#123;<span class="hljs-string">&quot;objective&quot;</span>: state[<span class="hljs-string">&quot;input&quot;</span>]&#125;)<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;plan&quot;</span>: plan.steps&#125;<br><br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">replan_step</span>(<span class="hljs-params">state: PlanExecute</span>):<br>    output = <span class="hljs-keyword">await</span> replanner.ainvoke(state)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(output, Response):<br>        <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;response&quot;</span>: output.response&#125;<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;plan&quot;</span>: output.steps&#125;<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">should_end</span>(<span class="hljs-params">state: PlanExecute</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;response&quot;</span> <span class="hljs-keyword">in</span> state <span class="hljs-keyword">and</span> state[<span class="hljs-string">&quot;response&quot;</span>]:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;True&quot;</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;False&quot;</span><br></code></pre></td></tr></table></figure><p><strong>定义Edges</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, END<br><br>workflow = StateGraph(PlanExecute)<br><br><span class="hljs-comment"># plan node</span><br>workflow.add_node(<span class="hljs-string">&quot;planner&quot;</span>, plan_step)<br><br><span class="hljs-comment"># execution step</span><br>workflow.add_node(<span class="hljs-string">&quot;agent&quot;</span>, execute_step)<br><br><span class="hljs-comment"># replan node</span><br>workflow.add_node(<span class="hljs-string">&quot;replan&quot;</span>, replan_step)<br><br>workflow.set_entry_point(<span class="hljs-string">&quot;planner&quot;</span>)<br><br><span class="hljs-comment"># plan  to agent</span><br>workflow.add_edge(<span class="hljs-string">&quot;planner&quot;</span>, <span class="hljs-string">&quot;agent&quot;</span>)<br><br><span class="hljs-comment"># agent, replan</span><br>workflow.add_edge(<span class="hljs-string">&quot;agent&quot;</span>, <span class="hljs-string">&quot;replan&quot;</span>)<br><br>workflow.add_conditional_edges(<br>    <span class="hljs-string">&quot;replan&quot;</span>,<br>    <span class="hljs-comment"># Next, we pass in the function that will determine which node is called next.</span><br>    should_end,<br>    &#123;<br>        <span class="hljs-comment"># If `tools`, then we call the tool node.</span><br>        <span class="hljs-string">&quot;True&quot;</span>: END,<br>        <span class="hljs-string">&quot;False&quot;</span>: <span class="hljs-string">&quot;agent&quot;</span>,<br>    &#125;,<br>)<br><br><span class="hljs-comment"># 编译成runnable</span><br>app = workflow.<span class="hljs-built_in">compile</span>()<br></code></pre></td></tr></table></figure><p><strong>执行</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> HumanMessage<br><br>config = &#123;<span class="hljs-string">&quot;recursion_limit&quot;</span>: <span class="hljs-number">50</span>&#125;<br>inputs = &#123;<span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;what is the hometown of the 2024 Australia open winner?&quot;</span>&#125;<br><span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> event <span class="hljs-keyword">in</span> app.astream(inputs, config=config):<br>    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> event.items():<br>        <span class="hljs-keyword">if</span> k != <span class="hljs-string">&quot;__end__&quot;</span>:<br>            <span class="hljs-built_in">print</span>(v)<br></code></pre></td></tr></table></figure><p>输出</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">&#123;&#x27;plan&#x27;: [&#x27;Identify the winner of the 2024 Australia Open.&#x27;, &quot;Research the winner&#x27;s biography to find out their hometown.&quot;, &#x27;Confirm the hometown from multiple sources to ensure accuracy.&#x27;]&#125;<br>&#123;&#x27;past_steps&#x27;: (&#x27;Identify the winner of the 2024 Australia Open.&#x27;, &#x27;The winner of the 2024 Australian Open is Jannik Sinner. He won his first Grand Slam title by defeating Daniil Medvedev in a thrilling five-set final.&#x27;)&#125;<br>&#123;&#x27;plan&#x27;: [&quot;Research Jannik Sinner&#x27;s biography to find out his hometown.&quot;, &#x27;Confirm the hometown from multiple sources to ensure accuracy.&#x27;]&#125;<br>&#123;&#x27;past_steps&#x27;: (&quot;Research Jannik Sinner&#x27;s biography to find out his hometown.&quot;, &quot;Jannik Sinner&#x27;s hometown is Innichen, a town located in the mainly German-speaking area of South Tyrol in northern Italy.&quot;)&#125;<br>&#123;&#x27;response&#x27;: &#x27;The hometown of the 2024 Australian Open winner, Jannik Sinner, is Innichen, Italy.&#x27;&#125;<br></code></pre></td></tr></table></figure><p>LangSmith流程展示(太长，有部分折叠)：</p><p><img src="/images/Plan-And-Execute.png" srcset="/img/loading.gif" lazyload /></p>
        </div>
      </div>
    </div>
<h3 id="reasoning-without-observations-rewoo">1.3 Reasoning WithOut
Observations (ReWOO)</h3>
<p><a
target="_blank" rel="noopener" href="https://arxiv.org/abs/2305.18323">ReWOO</a>论文提出了一种Agent，在这个Agent中并不是每个任务都会使用
LLM
，同时仍然允许任务依赖于先前的任务结果。他们通过允许在Planner的输出中进行变量分配来实现这一点。下图是Agent设计的示意图。</p>
<p><img src="/images/rewoo.png" srcset="/img/loading.gif" lazyload /></p>
<p>Planner生成一个由<code>Plan</code>和<code>E#</code>交错组成的列表，例如：假设用户查询“今年超级碗竞争者四分卫的统计数据是什么”，Planner可以生成以下计划：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs text">Plan: I need to know the teams playing in the superbowl this year<br>E1: Search[Who is competing in the superbowl?]<br>Plan: I need to know the quarterbacks for each team<br>E2: LLM[Quarterback for the first team of #E1]<br>Plan: I need to know the quarterbacks for each team<br>E3: LLM[Quarter back for the second team of #E1]<br>Plan: I need to look up stats for the first quarterback<br>E4: Search[Stats for #E2]<br>Plan: I need to look up stats for the second quarterback<br>E5: Search[Stats for #E3]<br></code></pre></td></tr></table></figure>
<ul>
<li>Planner可以使用类似<code>#E2</code>的语法引用之前的输出。这意味着它在执行任务列表时不必每次都重新规划。</li>
<li><code>work</code>节点循环遍历每个任务，并将任务输出分配给相应的变量。当调用后续调用时，它还会用变量的结果替换变量。</li>
<li>最后，<code>slover</code>将所有这些输出整合为最终答案。</li>
</ul>
<p>这个设计比原生的 <code>Plan-and-Execute Agent</code>
更有效，每个任务只具有所需的上下文（其输入和变量值）。</p>
<ul>
<li>允许在规划器的输出中进行变量赋值，从而在不需要每次都使用LLM的情况下执行任务，同时允许任务依赖于之前任务的结果。然而，它仍然依赖于顺序任务执行，这可能会产生更长的运行时间。</li>
</ul>

    <div class="fold">
      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-cb4deff6" role="button" aria-expanded="false" aria-controls="collapse-cb4deff6">
        <div class="fold-arrow">▶</div>LangGraph代码示例
      </div>
      <div class="fold-collapse collapse" id="collapse-cb4deff6">
        <div class="fold-content">
          <p><strong>定义模型</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI<br><br>model = ChatOpenAI(temperature=<span class="hljs-number">0</span>)<br><br>prompt = <span class="hljs-string">&quot;&quot;&quot;For the following task, make plans that can solve the problem step by step. For each plan, indicate \</span><br><span class="hljs-string">which external tool together with tool input to retrieve evidence. You can store the evidence into a \</span><br><span class="hljs-string">variable #E that can be called by later tools. (Plan, #E1, Plan, #E2, Plan, ...)</span><br><span class="hljs-string"></span><br><span class="hljs-string">Tools can be one of the following:</span><br><span class="hljs-string">(1) Google[input]: Worker that searches results from Google. Useful when you need to find short</span><br><span class="hljs-string">and succinct answers about a specific topic. The input should be a search query.</span><br><span class="hljs-string">(2) LLM[input]: A pretrained LLM like yourself. Useful when you need to act with general</span><br><span class="hljs-string">world knowledge and common sense. Prioritize it when you are confident in solving the problem</span><br><span class="hljs-string">yourself. Input can be any instruction.</span><br><span class="hljs-string"></span><br><span class="hljs-string">For example,</span><br><span class="hljs-string">Task: Thomas, Toby, and Rebecca worked a total of 157 hours in one week. Thomas worked x</span><br><span class="hljs-string">hours. Toby worked 10 hours less than twice what Thomas worked, and Rebecca worked 8 hours</span><br><span class="hljs-string">less than Toby. How many hours did Rebecca work?</span><br><span class="hljs-string">Plan: Given Thomas worked x hours, translate the problem into algebraic expressions and solve</span><br><span class="hljs-string">with Wolfram Alpha. #E1 = WolframAlpha[Solve x + (2x − 10) + ((2x − 10) − 8) = 157]</span><br><span class="hljs-string">Plan: Find out the number of hours Thomas worked. #E2 = LLM[What is x, given #E1]</span><br><span class="hljs-string">Plan: Calculate the number of hours Rebecca worked. #E3 = Calculator[(2 ∗ #E2 − 10) − 8]</span><br><span class="hljs-string"></span><br><span class="hljs-string">Begin! </span><br><span class="hljs-string">Describe your plans with rich details. Each Plan should be followed by only one #E.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Task: &#123;task&#125;&quot;&quot;&quot;</span><br><br>task = <span class="hljs-string">&quot;what is the hometown of the 2024 australian open winner&quot;</span><br></code></pre></td></tr></table></figure><p><strong>Graph State</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict, <span class="hljs-type">List</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ReWOO</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):<br>    task: <span class="hljs-built_in">str</span><br>    plan_string: <span class="hljs-built_in">str</span><br>    steps: <span class="hljs-type">List</span><br>    results: <span class="hljs-built_in">dict</span><br>    result: <span class="hljs-built_in">str</span><br></code></pre></td></tr></table></figure><p><strong>Planner Node</strong></p><p><img src="/images/rewoo-paper-workflow.png" srcset="/img/loading.gif" lazyload /></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><br><span class="hljs-comment"># Regex to match expressions of the form E#... = ...[...]</span><br>regex_pattern = <span class="hljs-string">r&quot;Plan:\s*(.+)\s*(#E\d+)\s*=\s*(\w+)\s*\[([^\]]+)\]&quot;</span><br>prompt_template = ChatPromptTemplate.from_messages([(<span class="hljs-string">&quot;user&quot;</span>, prompt)])<br>planner = prompt_template | model<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_plan</span>(<span class="hljs-params">state: ReWOO</span>):<br>    task = state[<span class="hljs-string">&quot;task&quot;</span>]<br>    result = planner.invoke(&#123;<span class="hljs-string">&quot;task&quot;</span>: task&#125;)<br>    <span class="hljs-comment"># Find all matches in the sample text</span><br>    matches = re.findall(regex_pattern, result.content)<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;steps&quot;</span>: matches, <span class="hljs-string">&quot;plan_string&quot;</span>: result.content&#125;<br></code></pre></td></tr></table></figure><p><strong>Executor</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_community.tools.tavily_search <span class="hljs-keyword">import</span> TavilySearchResults<br><br>search = TavilySearchResults()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_current_task</span>(<span class="hljs-params">state: ReWOO</span>):<br>    <span class="hljs-keyword">if</span> state[<span class="hljs-string">&quot;results&quot;</span>] <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(state[<span class="hljs-string">&quot;results&quot;</span>]) == <span class="hljs-built_in">len</span>(state[<span class="hljs-string">&quot;steps&quot;</span>]):<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(state[<span class="hljs-string">&quot;results&quot;</span>]) + <span class="hljs-number">1</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">tool_execution</span>(<span class="hljs-params">state: ReWOO</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Worker node that executes the tools of a given plan.&quot;&quot;&quot;</span><br>    _step = _get_current_task(state)<br>    _, step_name, tool, tool_input = state[<span class="hljs-string">&quot;steps&quot;</span>][_step - <span class="hljs-number">1</span>]<br>    _results = state[<span class="hljs-string">&quot;results&quot;</span>] <span class="hljs-keyword">or</span> &#123;&#125;<br>    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> _results.items():<br>        tool_input = tool_input.replace(k, v)<br>    <span class="hljs-keyword">if</span> tool == <span class="hljs-string">&quot;Google&quot;</span>:<br>        result = search.invoke(tool_input)<br>    <span class="hljs-keyword">elif</span> tool == <span class="hljs-string">&quot;LLM&quot;</span>:<br>        result = model.invoke(tool_input)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> ValueError<br>    _results[step_name] = <span class="hljs-built_in">str</span>(result)<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;results&quot;</span>: _results&#125;<br></code></pre></td></tr></table></figure><p><strong>Solver</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python">solve_prompt = <span class="hljs-string">&quot;&quot;&quot;Solve the following task or problem. To solve the problem, we have made step-by-step Plan and \</span><br><span class="hljs-string">retrieved corresponding Evidence to each Plan. Use them with caution since long evidence might \</span><br><span class="hljs-string">contain irrelevant information.</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#123;plan&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">Now solve the question or task according to provided Evidence above. Respond with the answer</span><br><span class="hljs-string">directly with no extra words.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Task: &#123;task&#125;</span><br><span class="hljs-string">Response:&quot;&quot;&quot;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solve</span>(<span class="hljs-params">state: ReWOO</span>):<br>    plan = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> _plan, step_name, tool, tool_input <span class="hljs-keyword">in</span> state[<span class="hljs-string">&quot;steps&quot;</span>]:<br>        _results = state[<span class="hljs-string">&quot;results&quot;</span>] <span class="hljs-keyword">or</span> &#123;&#125;<br>        <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> _results.items():<br>            tool_input = tool_input.replace(k, v)<br>            step_name = step_name.replace(k, v)<br>        plan += <span class="hljs-string">f&quot;Plan: <span class="hljs-subst">&#123;_plan&#125;</span>\n<span class="hljs-subst">&#123;step_name&#125;</span> = <span class="hljs-subst">&#123;tool&#125;</span>[<span class="hljs-subst">&#123;tool_input&#125;</span>]&quot;</span><br>    prompt = solve_prompt.<span class="hljs-built_in">format</span>(plan=plan, task=state[<span class="hljs-string">&quot;task&quot;</span>])<br>    result = model.invoke(prompt)<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;result&quot;</span>: result.content&#125;<br></code></pre></td></tr></table></figure><p><strong>Graph</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, END<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_route</span>(<span class="hljs-params">state</span>):<br>    _step = _get_current_task(state)<br>    <span class="hljs-keyword">if</span> _step <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-comment"># We have executed all tasks</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;solve&quot;</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># We are still executing tasks, loop back to the &quot;tool&quot; node</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;tool&quot;</span><br><br>graph = StateGraph(ReWOO)<br>graph.add_node(<span class="hljs-string">&quot;plan&quot;</span>, get_plan)<br>graph.add_node(<span class="hljs-string">&quot;tool&quot;</span>, tool_execution)<br>graph.add_node(<span class="hljs-string">&quot;solve&quot;</span>, solve)<br>graph.add_edge(<span class="hljs-string">&quot;plan&quot;</span>, <span class="hljs-string">&quot;tool&quot;</span>)<br>graph.add_edge(<span class="hljs-string">&quot;solve&quot;</span>, END)<br>graph.add_conditional_edges(<span class="hljs-string">&quot;tool&quot;</span>, _route)<br>graph.set_entry_point(<span class="hljs-string">&quot;plan&quot;</span>)<br><br><br>app = graph.<span class="hljs-built_in">compile</span>()<br></code></pre></td></tr></table></figure><p><strong>执行</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> app.stream(&#123;<span class="hljs-string">&quot;task&quot;</span>: task&#125;):<br>    <span class="hljs-built_in">print</span>(s)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;---&quot;</span>)<br></code></pre></td></tr></table></figure><p>输出</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">&#123;&#x27;plan&#x27;: &#123;&#x27;plan_string&#x27;: &#x27;Plan: Use Google to search for the 2024 Australian Open winner. #E1 = Google[2024 Australian Open winner]\nPlan: Once the winner is identified, search for their hometown using Google. #E2 = Google[Hometown of 2024 Australian Open winner]&#x27;, &#x27;steps&#x27;: [(&#x27;Use Google to search for the 2024 Australian Open winner. &#x27;, &#x27;#E1&#x27;, &#x27;Google&#x27;, &#x27;2024 Australian Open winner&#x27;), (&#x27;Once the winner is identified, search for their hometown using Google. &#x27;, &#x27;#E2&#x27;, &#x27;Google&#x27;, &#x27;Hometown of 2024 Australian Open winner&#x27;)]&#125;&#125;<br>---<br>&#123;&#x27;tool&#x27;: &#123;&#x27;results&#x27;: &#123;&#x27;#E1&#x27;: &#x27;[&#123;\&#x27;url\&#x27;: \&#x27;https://ausopen.com/articles/news/sinner-winner-italian-takes-first-major-ao-2024\&#x27;, \&#x27;content\&#x27;: \&#x27;The agile right-hander, who had claimed victory from a two-set deficit only once previously in his young career, is the second Italian man to achieve singles glory at a major, following Adriano Panatta in1976.With victories over Andrey Rublev, 10-time AO champion Novak Djokovic, and Medvedev, the Italian is the youngest player to defeat top 5 opponents in the final three matches of a major since Michael Stich did it at Wimbledon in 1991 – just weeks before Sinner was born.\\n He saved the only break he faced with an ace down the tee, and helped by scoreboard pressure, broke Medvedev by slamming a huge forehand to force an error from his more experienced rival, sealing the fourth set to take the final to a decider.\\n Sensing a shift in momentum as Medvedev served to close out the second at 5-3, Sinner set the RLA crowd alight with a pair of brilliant passing shots en route to creating a break point opportunity, which Medvedev snuffed out with trademark patience, drawing a forehand error from his opponent. “We are trying to get better every day, even during the tournament we try to get stronger, trying to understand every situation a little bit better, and I’m so glad to have you there supporting me, understanding me, which sometimes it’s not easy because I am a little bit young sometimes,” he said with a smile.\\n Medvedev, who held to love in his first three service games of the second set, piled pressure on the Italian, forcing the right-hander to produce his best tennis to save four break points in a nearly 12-minute second game.\\n\&#x27;&#125;, &#123;\&#x27;url\&#x27;: \&#x27;https://m.youtube.com/watch?v=frRVq6FI_5c\&#x27;, \&#x27;content\&#x27;: \&#x27;Watch the highlights of Jannik Sinner v Daniil Medvedev in the final of the Australian Open 2024.Subscribe to keep up with the latest from the Australian Ope...\&#x27;&#125;, &#123;\&#x27;url\&#x27;: \&#x27;https://www.bbc.com/sport/tennis/68120937\&#x27;, \&#x27;content\&#x27;: \&#x27;Live scores, results and order of play\\nAlerts: Get tennis news sent to your phone\\nRelated Topics\\nTop Stories\\nFA Cup: Blackburn Rovers v Wrexham - live text commentary\\nRussian skater Valieva given four-year ban for doping\\nLinks to Barcelona are \\\&#x27;totally untrue\\\&#x27; - Arteta\\nElsewhere on the BBC\\nThe truth behind the fake grooming scandal\\nFeaturing unseen police footage and interviews with the officers at the heart of the case\\nDid their father and uncle kill Nazi war criminals?\\n A real-life murder mystery following three brothers in their quest for the truth\\nWhat was it like to travel on the fastest plane?\\nTake a behind-the-scenes look at the supersonic story of the Concorde\\nToxic love, ruthless ambition and shocking betrayal\\nTell Me Lies follows a passionate college relationship with unimaginable consequences...\\n &quot;\\nMarathon man Medvedev runs out of steam\\nMedvedev is the first player to lose two Grand Slam finals after winning the opening two sets\\nSo many players with the experience of a Grand Slam final have talked about how different the occasion can be, particularly if it is the first time, and potentially overwhelming.\\n Jannik Sinner beats Daniil Medvedev in Melbourne final\\nJannik Sinner is the youngest player to win the Australian Open men\\\&#x27;s title since Novak Djokovic in 2008\\nJannik Sinner landed the Grand Slam title he has long promised with an extraordinary fightback to beat Daniil Medvedev in the Australian Open final.\\n &quot;\\nSinner starts 2024 in inspired form\\nSinner won the first Australian Open men\\\&#x27;s final since 2005 which did not feature Roger Federer, Rafael Nadal or Novak Djokovic\\nSinner was brought to the forefront of conversation when discussing Grand Slam champions in 2024 following a stunning end to last season.\\n\&#x27;&#125;, &#123;\&#x27;url\&#x27;: \&#x27;https://www.cbssports.com/tennis/news/australian-open-2024-jannik-sinner-claims-first-grand-slam-title-in-epic-comeback-win-over-daniil-medvedev/\&#x27;, \&#x27;content\&#x27;: \&#x27;&quot;\\nOur Latest Tennis Stories\\nSinner makes epic comeback to win Australian Open\\nSinner, Sabalenka win Australian Open singles titles\\n2024 Australian Open odds, Sinner vs. Medvedev picks\\nSabalenka defeats Zheng to win 2024 Australian Open\\n2024 Australian Open odds, Sabalenka vs. Zheng picks\\n2024 Australian Open odds, Medvedev vs. Zverev picks\\nAustralian Open odds: Djokovic vs. Sinner picks, bets\\nAustralian Open odds: Gauff vs. Sabalenka picks, bets\\nAustralian Open odds: Zheng vs. Yastremska picks, bets\\nNick Kyrgios reveals he\\\&#x27;s contemplating retirement\\n© 2004-2024 CBS Interactive. Jannik Sinner claims first Grand Slam title in epic comeback win over Daniil Medvedev\\nSinner, 22, rallied back from a two-set deficit to become the third ever Italian Grand Slam men\\\&#x27;s singles champion\\nAfter almost four hours, Jannik Sinner climbed back from a two-set deficit to win his first ever Grand Slam title with an epic 3-6, 3-6, 6-4, 6-4, 6-3 comeback victory against Daniil Medvedev. Sinner became the first Italian man to win the Australian Open since 1976, and just the eighth man to successfully come back from two sets down in a major final.\\n He did not drop a single set until his meeting with Djokovic, and that win in itself was an accomplishment as Djokovic was riding a 33-match winning streak at the Australian Open and had never lost a semifinal in Melbourne.\\n @janniksin • @wwos • @espn • @eurosport • @wowowtennis pic.twitter.com/DTCIqWoUoR\\n&quot;We are trying to get better everyday, and even during the tournament, trying to get stronger and understand the situation a little bit better,&quot; Sinner said.\&#x27;&#125;, &#123;\&#x27;url\&#x27;: \&#x27;https://www.cnn.com/2024/01/28/sport/jannik-sinner-daniil-medvedev-2024-australian-open-spt-intl/index.html\&#x27;, \&#x27;content\&#x27;: \&#x27;Related article\\nMeet the Carota Boys, the carrot-clad fan group rooting for Jannik Sinner, Italy’s rising tennis star\\nSuch drama provided a fitting finale for a tournament which has featured an incredible 35 five-set thrillers, equaling the Open Era record for any grand slam, as Medvedev raced to a two-set lead, initially heaping pressure on the young Italian who was left defending from every corner of the court in the wake of the No. 3 seed’s precise, aggressive approach.\\n CNN values your feedback\\nJannik Sinner rallies from two sets down to win men’s Australian Open final over Daniil Medvedev, his first grand slam title\\nFollow:\\nJannik Sinner overcame a two-set deficit to defeat Russia’s Daniil Medvedev 3-6 3-6 6-4 6-4 6-3 in a thrilling five-set final and claim the men’s Australian Open title on Sunday, becoming the first Italian man to win a grand slam since 1976.\\n While Sinner was appearing in his first ever grand slam final, Medvedev is already a grand slam champion who was playing in his fourth major final and that disparity in experience initally showed as the Russian controlled the pace of the match with 14 winners and five aces in the first set.\\n As Medvedev tired, Sinner took control of the match and sealed a crucial break point early in the fifth set with a crosscourt forehand winner before completing his remarkable comeback with a forehand down the line, falling to the floor immediately afterwards to celebrate a stunning maiden grand slam title.\\n That momentum carried Sinner through the fourth and fifth sets as he overturned the deficit and became the youngest male player to win the Australian Open since 2008, as well as just the third Italian man to ever win a grand slam.\\n\&#x27;&#125;]&#x27;&#125;&#125;&#125;<br>---<br>&#123;&#x27;tool&#x27;: &#123;&#x27;results&#x27;: &#123;&#x27;#E1&#x27;: &#x27;[&#123;\&#x27;url\&#x27;: \&#x27;https://ausopen.com/articles/news/sinner-winner-italian-takes-first-major-ao-2024\&#x27;, \&#x27;content\&#x27;: \&#x27;The agile right-hander, who had claimed victory from a two-set deficit only once previously in his young career, is the second Italian man to achieve singles glory at a major, following Adriano Panatta in1976.With victories over Andrey Rublev, 10-time AO champion Novak Djokovic, and Medvedev, the Italian is the youngest player to defeat top 5 opponents in the final three matches of a major since Michael Stich did it at Wimbledon in 1991 – just weeks before Sinner was born.\\n He saved the only break he faced with an ace down the tee, and helped by scoreboard pressure, broke Medvedev by slamming a huge forehand to force an error from his more experienced rival, sealing the fourth set to take the final to a decider.\\n Sensing a shift in momentum as Medvedev served to close out the second at 5-3, Sinner set the RLA crowd alight with a pair of brilliant passing shots en route to creating a break point opportunity, which Medvedev snuffed out with trademark patience, drawing a forehand error from his opponent. “We are trying to get better every day, even during the tournament we try to get stronger, trying to understand every situation a little bit better, and I’m so glad to have you there supporting me, understanding me, which sometimes it’s not easy because I am a little bit young sometimes,” he said with a smile.\\n Medvedev, who held to love in his first three service games of the second set, piled pressure on the Italian, forcing the right-hander to produce his best tennis to save four break points in a nearly 12-minute second game.\\n\&#x27;&#125;, &#123;\&#x27;url\&#x27;: \&#x27;https://m.youtube.com/watch?v=frRVq6FI_5c\&#x27;, \&#x27;content\&#x27;: \&#x27;Watch the highlights of Jannik Sinner v Daniil Medvedev in the final of the Australian Open 2024.Subscribe to keep up with the latest from the Australian Ope...\&#x27;&#125;, &#123;\&#x27;url\&#x27;: \&#x27;https://www.bbc.com/sport/tennis/68120937\&#x27;, \&#x27;content\&#x27;: \&#x27;Live scores, results and order of play\\nAlerts: Get tennis news sent to your phone\\nRelated Topics\\nTop Stories\\nFA Cup: Blackburn Rovers v Wrexham - live text commentary\\nRussian skater Valieva given four-year ban for doping\\nLinks to Barcelona are \\\&#x27;totally untrue\\\&#x27; - Arteta\\nElsewhere on the BBC\\nThe truth behind the fake grooming scandal\\nFeaturing unseen police footage and interviews with the officers at the heart of the case\\nDid their father and uncle kill Nazi war criminals?\\n A real-life murder mystery following three brothers in their quest for the truth\\nWhat was it like to travel on the fastest plane?\\nTake a behind-the-scenes look at the supersonic story of the Concorde\\nToxic love, ruthless ambition and shocking betrayal\\nTell Me Lies follows a passionate college relationship with unimaginable consequences...\\n &quot;\\nMarathon man Medvedev runs out of steam\\nMedvedev is the first player to lose two Grand Slam finals after winning the opening two sets\\nSo many players with the experience of a Grand Slam final have talked about how different the occasion can be, particularly if it is the first time, and potentially overwhelming.\\n Jannik Sinner beats Daniil Medvedev in Melbourne final\\nJannik Sinner is the youngest player to win the Australian Open men\\\&#x27;s title since Novak Djokovic in 2008\\nJannik Sinner landed the Grand Slam title he has long promised with an extraordinary fightback to beat Daniil Medvedev in the Australian Open final.\\n &quot;\\nSinner starts 2024 in inspired form\\nSinner won the first Australian Open men\\\&#x27;s final since 2005 which did not feature Roger Federer, Rafael Nadal or Novak Djokovic\\nSinner was brought to the forefront of conversation when discussing Grand Slam champions in 2024 following a stunning end to last season.\\n\&#x27;&#125;, &#123;\&#x27;url\&#x27;: \&#x27;https://www.cbssports.com/tennis/news/australian-open-2024-jannik-sinner-claims-first-grand-slam-title-in-epic-comeback-win-over-daniil-medvedev/\&#x27;, \&#x27;content\&#x27;: \&#x27;&quot;\\nOur Latest Tennis Stories\\nSinner makes epic comeback to win Australian Open\\nSinner, Sabalenka win Australian Open singles titles\\n2024 Australian Open odds, Sinner vs. Medvedev picks\\nSabalenka defeats Zheng to win 2024 Australian Open\\n2024 Australian Open odds, Sabalenka vs. Zheng picks\\n2024 Australian Open odds, Medvedev vs. Zverev picks\\nAustralian Open odds: Djokovic vs. Sinner picks, bets\\nAustralian Open odds: Gauff vs. Sabalenka picks, bets\\nAustralian Open odds: Zheng vs. Yastremska picks, bets\\nNick Kyrgios reveals he\\\&#x27;s contemplating retirement\\n© 2004-2024 CBS Interactive. Jannik Sinner claims first Grand Slam title in epic comeback win over Daniil Medvedev\\nSinner, 22, rallied back from a two-set deficit to become the third ever Italian Grand Slam men\\\&#x27;s singles champion\\nAfter almost four hours, Jannik Sinner climbed back from a two-set deficit to win his first ever Grand Slam title with an epic 3-6, 3-6, 6-4, 6-4, 6-3 comeback victory against Daniil Medvedev. Sinner became the first Italian man to win the Australian Open since 1976, and just the eighth man to successfully come back from two sets down in a major final.\\n He did not drop a single set until his meeting with Djokovic, and that win in itself was an accomplishment as Djokovic was riding a 33-match winning streak at the Australian Open and had never lost a semifinal in Melbourne.\\n @janniksin • @wwos • @espn • @eurosport • @wowowtennis pic.twitter.com/DTCIqWoUoR\\n&quot;We are trying to get better everyday, and even during the tournament, trying to get stronger and understand the situation a little bit better,&quot; Sinner said.\&#x27;&#125;, &#123;\&#x27;url\&#x27;: \&#x27;https://www.cnn.com/2024/01/28/sport/jannik-sinner-daniil-medvedev-2024-australian-open-spt-intl/index.html\&#x27;, \&#x27;content\&#x27;: \&#x27;Related article\\nMeet the Carota Boys, the carrot-clad fan group rooting for Jannik Sinner, Italy’s rising tennis star\\nSuch drama provided a fitting finale for a tournament which has featured an incredible 35 five-set thrillers, equaling the Open Era record for any grand slam, as Medvedev raced to a two-set lead, initially heaping pressure on the young Italian who was left defending from every corner of the court in the wake of the No. 3 seed’s precise, aggressive approach.\\n CNN values your feedback\\nJannik Sinner rallies from two sets down to win men’s Australian Open final over Daniil Medvedev, his first grand slam title\\nFollow:\\nJannik Sinner overcame a two-set deficit to defeat Russia’s Daniil Medvedev 3-6 3-6 6-4 6-4 6-3 in a thrilling five-set final and claim the men’s Australian Open title on Sunday, becoming the first Italian man to win a grand slam since 1976.\\n While Sinner was appearing in his first ever grand slam final, Medvedev is already a grand slam champion who was playing in his fourth major final and that disparity in experience initally showed as the Russian controlled the pace of the match with 14 winners and five aces in the first set.\\n As Medvedev tired, Sinner took control of the match and sealed a crucial break point early in the fifth set with a crosscourt forehand winner before completing his remarkable comeback with a forehand down the line, falling to the floor immediately afterwards to celebrate a stunning maiden grand slam title.\\n That momentum carried Sinner through the fourth and fifth sets as he overturned the deficit and became the youngest male player to win the Australian Open since 2008, as well as just the third Italian man to ever win a grand slam.\\n\&#x27;&#125;]&#x27;, &#x27;#E2&#x27;: &#x27;[&#123;\&#x27;url\&#x27;: &quot;https://en.wikipedia.org/wiki/2024_Australian_Open_–_Men\&#x27;s_singles_final&quot;, \&#x27;content\&#x27;: &quot;This was the first Australian Open final since 2005 not to feature any of the Big Three members.[5]\\nMedvedev set an Open Era record for the most time spent playing at a singles major, at 24 hours and 17 minutes.[6] Medvedev also became the first player in the Open Era to lose two major finals after having a two-set lead.[7]\\nBackground[edit]\\nEntering the final, Medvedev lead the career head-to-head 6–3. He became the second Italian man in the Open Era to win a singles major, after Adriano Panatta at the 1976 French Open,[2] and the first new Australian Open champion in ten years, since Stan Wawrinka in 2014.[3] At 22, Sinner was the youngest Australian Open men\&#x27;s singles champion and finalist since Novak Djokovic in 2008.[4] Contents\\n2024 Australian Open – Men\&#x27;s singles final\\nThe 2024 Australian Open Men\&#x27;s Singles final was the championship tennis match of the men\&#x27;s singles tournament at the 2024 Australian Open, contested by fourth-seed Jannik Sinner and third-seed Daniil Medvedev. Also in the semifinals, Medvedev came back from two-sets-to-love down against Alexander Zverev to reach a third Australian Open final.[9] Medvedev had already played two other five-set matches, against Emil Ruusuvuori in the second round (when he came back from two-sets-to-love down as well) and against Hubert Hurkacz in the quarterfinals.\\n Novak Djokovic, ending his 33-match winning streak at the Australian Open (dating back from the 2019 tournament), as well as marking the Serbian\&#x27;s first-ever defeat in an Australian Open semifinal and his first defeat in any major semifinal since the 2019 French Open.&quot;&#125;, &#123;\&#x27;url\&#x27;: \&#x27;https://ausopen.com/articles/news/sinner-winner-italian-takes-first-major-ao-2024\&#x27;, \&#x27;content\&#x27;: \&#x27;The agile right-hander, who had claimed victory from a two-set deficit only once previously in his young career, is the second Italian man to achieve singles glory at a major, following Adriano Panatta in1976.With victories over Andrey Rublev, 10-time AO champion Novak Djokovic, and Medvedev, the Italian is the youngest player to defeat top 5 opponents in the final three matches of a major since Michael Stich did it at Wimbledon in 1991 – just weeks before Sinner was born.\\n He saved the only break he faced with an ace down the tee, and helped by scoreboard pressure, broke Medvedev by slamming a huge forehand to force an error from his more experienced rival, sealing the fourth set to take the final to a decider.\\n Sensing a shift in momentum as Medvedev served to close out the second at 5-3, Sinner set the RLA crowd alight with a pair of brilliant passing shots en route to creating a break point opportunity, which Medvedev snuffed out with trademark patience, drawing a forehand error from his opponent. “We are trying to get better every day, even during the tournament we try to get stronger, trying to understand every situation a little bit better, and I’m so glad to have you there supporting me, understanding me, which sometimes it’s not easy because I am a little bit young sometimes,” he said with a smile.\\n Medvedev, who held to love in his first three service games of the second set, piled pressure on the Italian, forcing the right-hander to produce his best tennis to save four break points in a nearly 12-minute second game.\\n\&#x27;&#125;, &#123;\&#x27;url\&#x27;: \&#x27;https://www.bbc.com/sport/tennis/68120937\&#x27;, \&#x27;content\&#x27;: \&#x27;Live scores, results and order of play\\nAlerts: Get tennis news sent to your phone\\nRelated Topics\\nTop Stories\\nFA Cup: Blackburn Rovers v Wrexham - live text commentary\\nRussian skater Valieva given four-year ban for doping\\nLinks to Barcelona are \\\&#x27;totally untrue\\\&#x27; - Arteta\\nElsewhere on the BBC\\nThe truth behind the fake grooming scandal\\nFeaturing unseen police footage and interviews with the officers at the heart of the case\\nDid their father and uncle kill Nazi war criminals?\\n A real-life murder mystery following three brothers in their quest for the truth\\nWhat was it like to travel on the fastest plane?\\nTake a behind-the-scenes look at the supersonic story of the Concorde\\nToxic love, ruthless ambition and shocking betrayal\\nTell Me Lies follows a passionate college relationship with unimaginable consequences...\\n &quot;\\nMarathon man Medvedev runs out of steam\\nMedvedev is the first player to lose two Grand Slam finals after winning the opening two sets\\nSo many players with the experience of a Grand Slam final have talked about how different the occasion can be, particularly if it is the first time, and potentially overwhelming.\\n Jannik Sinner beats Daniil Medvedev in Melbourne final\\nJannik Sinner is the youngest player to win the Australian Open men\\\&#x27;s title since Novak Djokovic in 2008\\nJannik Sinner landed the Grand Slam title he has long promised with an extraordinary fightback to beat Daniil Medvedev in the Australian Open final.\\n &quot;\\nSinner starts 2024 in inspired form\\nSinner won the first Australian Open men\\\&#x27;s final since 2005 which did not feature Roger Federer, Rafael Nadal or Novak Djokovic\\nSinner was brought to the forefront of conversation when discussing Grand Slam champions in 2024 following a stunning end to last season.\\n\&#x27;&#125;, &#123;\&#x27;url\&#x27;: \&#x27;https://en.wikipedia.org/wiki/2024_Australian_Open\&#x27;, \&#x27;content\&#x27;: &quot;The tournament featured the following changes from previous tournaments:[9]\\nSingles players[edit]\\nEvents[edit]\\nMen\&#x27;s singles[edit]\\nWomen\&#x27;s singles[edit]\\nMen\&#x27;s doubles[edit]\\nWomen\&#x27;s doubles[edit]\\nMixed doubles[edit]\\nWheelchair men\&#x27;s singles[edit]\\nWheelchair women\&#x27;s singles[edit]\\nWheelchair quad singles[edit]\\nWheelchair men\&#x27;s doubles[edit]\\nWheelchair women\&#x27;s doubles[edit]\\nWheelchair quad doubles[edit]\\nBoys\&#x27; singles[edit]\\nGirls\&#x27; singles[edit]\\nBoys\&#x27; doubles[edit]\\nGirls\&#x27; doubles[edit]\\nPoints and prize money[edit]\\nPoint distribution[edit]\\nBelow is a series of tables for each competition showing the ranking points offered for each event.[12][13][14]\\nPrize money[edit]\\nThe Australian Open total prize money for 2024 increased by 13.07% year on year to a tournament record A$86,500,000. Aryna Sabalenka successfully defended the women\&#x27;s singles title as she claimed her second major singles title, defeating Zheng Qinwen without losing a set during the tournament.[6][7]\\nIn the tournament\&#x27;s 119-year history, this was the first Australian Open Tennis Championships to be held on an opening Sunday.[8]\\n It was the 112th edition of the Australian Open, the 56th in the Open Era, and the first major of the year. The total represented a 162% increase in prize money over the last ten years, from the A$33 million on offer in 2014.\\n Contents\\n2024 Australian Open\\nThe 2024 Australian Open was a Grand Slam level tennis tournament held at Melbourne Park, from 14–28 January 2024.[1]&quot;&#125;, &#123;\&#x27;url\&#x27;: \&#x27;https://ausopen.com/articles/news/sinner-v-medvedev-how-ao-2024-mens-final-was-decided\&#x27;, \&#x27;content\&#x27;: &quot;MORE: All the stats from the AO 2024 men’s final\\nDaniil Medvedev could not maintain his scintillating start on Sunday night, while first-time major finalist Jannik Sinner simply grew in strength as the five-set contest progressed.\\nSinner, winner: Italian takes first major at AO 2024\\nNEWS\\nSinner, the morning after: “It\&#x27;s great emotions, slowly realising what I\&#x27;ve done”\\nNEWS\\n Sinner v Medvedev: How the AO 2024 men\&#x27;s final was decided\\nJannik Sinner weathered an early onslaught to reel in Daniil Medvedev, growing in potency to win the Australian Open 2024 final – his first Grand Slam singles title.\\n Early in the second set Medvedev was averaging 77 per cent of first serves in for the match, and towards the end of it this figure had dipped to 65. Medvedev had spent more than 20 hours on court in his previous six rounds, the equivalent of almost two more matches than Sinner (who had spent less than 15 hours on court in advancing to the final).\\n During the shift, Sinner’s forehand was gathering speed, having increased from an average of 122.3 km/h in the first set to 128.7 km/h by the third.\\n&quot;&#125;]&#x27;&#125;&#125;&#125;<br>---<br>&#123;&#x27;solve&#x27;: &#123;&#x27;result&#x27;: &#x27;The hometown of the 2024 Australian Open winner, Jannik Sinner, is Italy.&#x27;&#125;&#125;<br>---<br></code></pre></td></tr></table></figure><p>LangSmith流程展示：</p><p><img src="/images/LangSmith_ReWOO.png" srcset="/img/loading.gif" lazyload /></p>
        </div>
      </div>
    </div>
<h3 id="llmcompiler">1.4 LLMCompiler</h3>
<p><img src="/images/llm-compiler-1.png" srcset="/img/loading.gif" lazyload /></p>
<p><a
target="_blank" rel="noopener" href="https://arxiv.org/abs/2312.04511">LLMCompiler</a>是一种Agent架构，旨在进一步提高任务执行速度，超越了Plan-and-Execute和ReWOO
Agent，甚至超越了OpenAI的并行工具调用。</p>
<p>LLMCompiler有以下主要组件:</p>
<ul>
<li><strong>Planner</strong>：流式传输任务的
DAG。每个任务都包含一个工具、参数和依赖项列表。</li>
<li><strong>任务获取单元(Task Fetching
Unit)</strong>：调度和执行任务，接受任务流。一旦满足依赖关系就安排任务。由于许多工具涉及对搜索引擎或
LLM 的其他调用，因此额外的并行性可以显着提高速度（论文声称提高了 3.6
倍）</li>
<li><strong>Joiner</strong>：一个LLM步骤，根据整个图历史（包括任务执行结果）动态重新规划或结束，决定是否用最终答案响应，或者将进度传回规划代理继续工作。</li>
</ul>
<p>关键提升点：</p>
<ul>
<li>Planner的输出是流式的，输出解析器不停的解析任务参数及其依赖关系。</li>
<li>任务获取单元(Task Fetching
Unit)接收解析的任务流，并在满足所有任务的依赖关系后调度任务。</li>
<li>任务参数可以是变量，它们是 DAG 中先前任务的输出。 例如，模型可以调用
search(“${1}”) 来搜索任务 1 的输出生成的查询。这使得代理的工作速度比
OpenAI 中调用的并行工具更快。</li>
</ul>
<p>通过将任务格式化为
DAG，代理可以在调用工具时节省宝贵的时间，从而带来更好的整体用户体验。</p>

    <div class="fold">
      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-86153f53" role="button" aria-expanded="false" aria-controls="collapse-86153f53">
        <div class="fold-arrow">▶</div>LangGraph代码示例
      </div>
      <div class="fold-collapse collapse" id="collapse-86153f53">
        <div class="fold-content">
          <p><strong>定义模型和工具</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI<br><span class="hljs-keyword">from</span> langchain_community.tools.tavily_search <span class="hljs-keyword">import</span> TavilySearchResults<br><br><span class="hljs-keyword">from</span> langchain_community.tools.google_serper <span class="hljs-keyword">import</span> GoogleSerperResults<br><span class="hljs-keyword">from</span> langchain_community.utilities <span class="hljs-keyword">import</span> GoogleSerperAPIWrapper<br><br><span class="hljs-comment"># Imported from the https://github.com/langchain-ai/langgraph/tree/main/examples/plan-and-execute repo</span><br><span class="hljs-keyword">from</span> math_tools <span class="hljs-keyword">import</span> get_math_tool<br><br>calculate = get_math_tool(ChatOpenAI(model=<span class="hljs-string">&quot;gpt-4-turbo&quot;</span>))<br>search = GoogleSerperResults(api_wrapper=GoogleSerperAPIWrapper(k=<span class="hljs-number">1</span>),<br>                             description=<span class="hljs-string">&#x27;google_serper_results_json(query=&quot;the search query&quot;) - a search engine.&#x27;</span>,)<br><br>tools = [search, calculate]<br></code></pre></td></tr></table></figure><p><strong>Planner</strong><sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><spanclass="hint--top hint--rounded" aria-label="">[1]</span></a></sup></p><p>下面的代码构建了Planner的提示模板，并将其与 LLM 和输出解析器（在output_parser.py 中定义）组合在一起。输出解析器处理以下形式的任务列表：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">1. tool_1(arg1=&quot;arg1&quot;, arg2=3.5, ...)<br>Thought: I then want to find out Y by using tool_2<br>2. tool_2(arg1=&quot;&quot;, arg2=&quot;$&#123;1&#125;&quot;)&#x27;<br>3. join()&lt;END_OF_PLAN&gt;&quot;<br></code></pre></td></tr></table></figure><p><code>Thought</code>行是可选的。 ${1} 占位符是变量。它们用于将工具（任务）输出路由到其他工具。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Sequence</span><br><br><span class="hljs-keyword">from</span> langchain_core.language_models <span class="hljs-keyword">import</span> BaseChatModel<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableBranch<br><span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> BaseTool<br><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> (<br>    BaseMessage,<br>    FunctionMessage,<br>    HumanMessage,<br>    SystemMessage,<br>)<br><br><span class="hljs-keyword">from</span> output_parser <span class="hljs-keyword">import</span> LLMCompilerPlanParser, Task<br><span class="hljs-keyword">from</span> langchain <span class="hljs-keyword">import</span> hub<br><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI<br><br><br>prompt = hub.pull(<span class="hljs-string">&quot;wfh/llm-compiler&quot;</span>)<br><span class="hljs-built_in">print</span>(prompt.pretty_print())<br></code></pre></td></tr></table></figure><p>输出</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs text">================================ System Message ================================<br><br>Given a user query, create a plan to solve it with the utmost parallelizability. Each plan should comprise an action from the following &#123;num_tools&#125; types:<br>&#123;tool_descriptions&#125;<br>&#123;num_tools&#125;. join(): Collects and combines results from prior actions.<br><br> - An LLM agent is called upon invoking join() to either finalize the user query or wait until the plans are executed.<br> - join should always be the last action in the plan, and will be called in two scenarios:<br>   (a) if the answer can be determined by gathering the outputs from tasks to generate the final response.<br>   (b) if the answer cannot be determined in the planning phase before you execute the plans. Guidelines:<br> - Each action described above contains input/output types and description.<br>    - You must strictly adhere to the input and output types for each action.<br>    - The action descriptions contain the guidelines. You MUST strictly follow those guidelines when you use the actions.<br> - Each action in the plan should strictly be one of the above types. Follow the Python conventions for each action.<br> - Each action MUST have a unique ID, which is strictly increasing.<br> - Inputs for actions can either be constants or outputs from preceding actions. In the latter case, use the format $id to denote the ID of the previous action whose output will be the input.<br> - Always call join as the last action in the plan. Say &#x27;&lt;END_OF_PLAN&gt;&#x27; after you call join<br> - Ensure the plan maximizes parallelizability.<br> - Only use the provided action types. If a query cannot be addressed using these, invoke the join action for the next steps.<br> - Never introduce new actions other than the ones provided.<br><br>============================= Messages Placeholder =============================<br><br>&#123;messages&#125;<br><br>================================ System Message ================================<br><br>Remember, ONLY respond with the task list in the correct format! E.g.:<br>idx. tool(arg_name=args)<br>None<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_planner</span>(<span class="hljs-params"></span><br><span class="hljs-params">    llm: BaseChatModel, tools: <span class="hljs-type">Sequence</span>[BaseTool], base_prompt: ChatPromptTemplate</span><br><span class="hljs-params"></span>):<br>    tool_descriptions = <span class="hljs-string">&quot;\n&quot;</span>.join(<br>        <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;i+<span class="hljs-number">1</span>&#125;</span>. <span class="hljs-subst">&#123;tool.description&#125;</span>\n&quot;</span> <span class="hljs-keyword">for</span> i, tool <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(tools) <span class="hljs-comment"># +1 to offset the 0 starting index, we want it count normally from 1.</span><br>    )<br>    planner_prompt = base_prompt.partial(<br>        replan=<span class="hljs-string">&quot;&quot;</span>,<br>        num_tools=<span class="hljs-built_in">len</span>(tools)+<span class="hljs-number">1</span>, <span class="hljs-comment"># Add one because we&#x27;re adding the join() tool at the end.</span><br>        tool_descriptions=tool_descriptions,<br>    )<br>    replanner_prompt = base_prompt.partial(<br>        replan=<span class="hljs-string">&#x27; - You are given &quot;Previous Plan&quot; which is the plan that the previous agent created along with the execution results &#x27;</span><br>        <span class="hljs-string">&quot;(given as Observation) of each plan and a general thought (given as Thought) about the executed results.&quot;</span><br>        <span class="hljs-string">&#x27;You MUST use these information to create the next plan under &quot;Current Plan&quot;.\n&#x27;</span><br>        <span class="hljs-string">&#x27; - When starting the Current Plan, you should start with &quot;Thought&quot; that outlines the strategy for the next plan.\n&#x27;</span><br>        <span class="hljs-string">&quot; - In the Current Plan, you should NEVER repeat the actions that are already executed in the Previous Plan.\n&quot;</span><br>        <span class="hljs-string">&quot; - You must continue the task index from the end of the previous one. Do not repeat task indices.&quot;</span>,<br>        num_tools=<span class="hljs-built_in">len</span>(tools)+<span class="hljs-number">1</span>,<br>        tool_descriptions=tool_descriptions,<br>    )<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">should_replan</span>(<span class="hljs-params">state: <span class="hljs-built_in">list</span></span>):<br>        <span class="hljs-comment"># Context is passed as a system message</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">isinstance</span>(state[-<span class="hljs-number">1</span>], SystemMessage)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrap_messages</span>(<span class="hljs-params">state: <span class="hljs-built_in">list</span></span>):<br>        <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;messages&quot;</span>: state&#125;<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrap_and_get_last_index</span>(<span class="hljs-params">state: <span class="hljs-built_in">list</span></span>):<br>        next_task = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> state[::-<span class="hljs-number">1</span>]:<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(message, FunctionMessage):<br>                next_task = message.additional_kwargs[<span class="hljs-string">&quot;idx&quot;</span>] + <span class="hljs-number">1</span><br>                <span class="hljs-keyword">break</span><br>        state[-<span class="hljs-number">1</span>].content = state[-<span class="hljs-number">1</span>].content + <span class="hljs-string">f&quot; - Begin counting at : <span class="hljs-subst">&#123;next_task&#125;</span>&quot;</span><br>        <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;messages&quot;</span>: state&#125;<br><br>    <span class="hljs-keyword">return</span> (<br>        RunnableBranch(<br>            (should_replan, wrap_and_get_last_index | replanner_prompt),<br>            wrap_messages | planner_prompt,<br>        )<br>        | llm<br>        | LLMCompilerPlanParser(tools=tools)<br>    )<br><br>llm = ChatOpenAI(model=<span class="hljs-string">&quot;gpt-4-turbo&quot;</span>)<br><span class="hljs-comment"># This is the primary &quot;agent&quot; in our application</span><br>planner = create_planner(llm, tools, prompt)<br></code></pre></td></tr></table></figure><p><strong>Task Fetching Unit</strong></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript">&#123;<br>    <span class="hljs-attr">tool</span>: <span class="hljs-title class_">BaseTool</span>,<br>    <span class="hljs-attr">dependencies</span>: <span class="hljs-built_in">number</span>[],<br>&#125;<br></code></pre></td></tr></table></figure><p>基本思想是一旦满足工具的依赖性就开始执行工具。 这是通过多线程完成的。我们将下面的任务获取单元和执行器结合起来：</p><p><img src="/images/Task_Fetch_Unit.png" srcset="/img/loading.gif" lazyload /></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>, <span class="hljs-type">Union</span>, Iterable, <span class="hljs-type">List</span>, <span class="hljs-type">Tuple</span>, <span class="hljs-type">Dict</span><br><span class="hljs-keyword">from</span> typing_extensions <span class="hljs-keyword">import</span> TypedDict<br><span class="hljs-keyword">import</span> re<br><br><span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> (<br>    chain <span class="hljs-keyword">as</span> as_runnable,<br>)<br><br><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor, wait<br><span class="hljs-keyword">import</span> time<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_observations</span>(<span class="hljs-params">messages: <span class="hljs-type">List</span>[BaseMessage]</span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">int</span>, <span class="hljs-type">Any</span>]:<br>    <span class="hljs-comment"># Get all previous tool responses</span><br>    results = &#123;&#125;<br>    <span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> messages[::-<span class="hljs-number">1</span>]:<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(message, FunctionMessage):<br>            results[<span class="hljs-built_in">int</span>(message.additional_kwargs[<span class="hljs-string">&quot;idx&quot;</span>])] = message.content<br>    <span class="hljs-keyword">return</span> results<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SchedulerInput</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):<br>    messages: <span class="hljs-type">List</span>[BaseMessage]<br>    tasks: Iterable[Task]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_execute_task</span>(<span class="hljs-params">task, observations, config</span>):<br>    tool_to_use = task[<span class="hljs-string">&quot;tool&quot;</span>]<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(tool_to_use, <span class="hljs-built_in">str</span>):<br>        <span class="hljs-keyword">return</span> tool_to_use<br>    args = task[<span class="hljs-string">&quot;args&quot;</span>]<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(args, <span class="hljs-built_in">str</span>):<br>            resolved_args = _resolve_arg(args, observations)<br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(args, <span class="hljs-built_in">dict</span>):<br>            resolved_args = &#123;<br>                key: _resolve_arg(val, observations) <span class="hljs-keyword">for</span> key, val <span class="hljs-keyword">in</span> args.items()<br>            &#125;<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># This will likely fail</span><br>            resolved_args = args<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> (<br>            <span class="hljs-string">f&quot;ERROR(Failed to call <span class="hljs-subst">&#123;tool_to_use.name&#125;</span> with args <span class="hljs-subst">&#123;args&#125;</span>.)&quot;</span><br>            <span class="hljs-string">f&quot; Args could not be resolved. Error: <span class="hljs-subst">&#123;<span class="hljs-built_in">repr</span>(e)&#125;</span>&quot;</span><br>        )<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">return</span> tool_to_use.invoke(resolved_args, config)<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> (<br>            <span class="hljs-string">f&quot;ERROR(Failed to call <span class="hljs-subst">&#123;tool_to_use.name&#125;</span> with args <span class="hljs-subst">&#123;args&#125;</span>.&quot;</span><br>            + <span class="hljs-string">f&quot; Args resolved to <span class="hljs-subst">&#123;resolved_args&#125;</span>. Error: <span class="hljs-subst">&#123;<span class="hljs-built_in">repr</span>(e)&#125;</span>)&quot;</span><br>        )<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_resolve_arg</span>(<span class="hljs-params">arg: <span class="hljs-type">Union</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>], observations: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">int</span>, <span class="hljs-type">Any</span>]</span>):<br>    <span class="hljs-comment"># $1 or $&#123;1&#125; -&gt; 1</span><br>    ID_PATTERN = <span class="hljs-string">r&quot;\$\&#123;?(\d+)\&#125;?&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">replace_match</span>(<span class="hljs-params"><span class="hljs-keyword">match</span></span>):<br>        <span class="hljs-comment"># If the string is $&#123;123&#125;, match.group(0) is $&#123;123&#125;, and match.group(1) is 123.</span><br><br>        <span class="hljs-comment"># Return the match group, in this case the index, from the string. This is the index</span><br>        <span class="hljs-comment"># number we get back.</span><br>        idx = <span class="hljs-built_in">int</span>(<span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>))<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(observations.get(idx, <span class="hljs-keyword">match</span>.group(<span class="hljs-number">0</span>)))<br><br>    <span class="hljs-comment"># For dependencies on other tasks</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(arg, <span class="hljs-built_in">str</span>):<br>        <span class="hljs-keyword">return</span> re.sub(ID_PATTERN, replace_match, arg)<br>    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(arg, <span class="hljs-built_in">list</span>):<br>        <span class="hljs-keyword">return</span> [_resolve_arg(a, observations) <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> arg]<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(arg)<br><br><br><span class="hljs-meta">@as_runnable</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">schedule_task</span>(<span class="hljs-params">task_inputs, config</span>):<br>    task: Task = task_inputs[<span class="hljs-string">&quot;task&quot;</span>]<br>    observations: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">int</span>, <span class="hljs-type">Any</span>] = task_inputs[<span class="hljs-string">&quot;observations&quot;</span>]<br>    <span class="hljs-keyword">try</span>:<br>        observation = _execute_task(task, observations, config)<br>    <span class="hljs-keyword">except</span> Exception:<br>        <span class="hljs-keyword">import</span> traceback<br><br>        observation = traceback.format_exception()  <span class="hljs-comment"># repr(e) +</span><br>    observations[task[<span class="hljs-string">&quot;idx&quot;</span>]] = observation<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">schedule_pending_task</span>(<span class="hljs-params"></span><br><span class="hljs-params">    task: Task, observations: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">int</span>, <span class="hljs-type">Any</span>], retry_after: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.2</span></span><br><span class="hljs-params"></span>):<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        deps = task[<span class="hljs-string">&quot;dependencies&quot;</span>]<br>        <span class="hljs-keyword">if</span> deps <span class="hljs-keyword">and</span> (<span class="hljs-built_in">any</span>([dep <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> observations <span class="hljs-keyword">for</span> dep <span class="hljs-keyword">in</span> deps])):<br>            <span class="hljs-comment"># Dependencies not yet satisfied</span><br>            time.sleep(retry_after)<br>            <span class="hljs-keyword">continue</span><br>        schedule_task.invoke(&#123;<span class="hljs-string">&quot;task&quot;</span>: task, <span class="hljs-string">&quot;observations&quot;</span>: observations&#125;)<br>        <span class="hljs-keyword">break</span><br><br><br><span class="hljs-meta">@as_runnable</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">schedule_tasks</span>(<span class="hljs-params">scheduler_input: SchedulerInput</span>) -&gt; <span class="hljs-type">List</span>[FunctionMessage]:<br>    <span class="hljs-string">&quot;&quot;&quot;Group the tasks into a DAG schedule.&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># For streaming, we are making a few simplifying assumption:</span><br>    <span class="hljs-comment"># 1. The LLM does not create cyclic dependencies</span><br>    <span class="hljs-comment"># 2. That the LLM will not generate tasks with future deps</span><br>    <span class="hljs-comment"># If this ceases to be a good assumption, you can either</span><br>    <span class="hljs-comment"># adjust to do a proper topological sort (not-stream)</span><br>    <span class="hljs-comment"># or use a more complicated data structure</span><br>    tasks = scheduler_input[<span class="hljs-string">&quot;tasks&quot;</span>]<br>    args_for_tasks = &#123;&#125;<br>    messages = scheduler_input[<span class="hljs-string">&quot;messages&quot;</span>]<br>    <span class="hljs-comment"># If we are re-planning, we may have calls that depend on previous</span><br>    <span class="hljs-comment"># plans. Start with those.</span><br>    observations = _get_observations(messages)<br>    task_names = &#123;&#125;<br>    originals = <span class="hljs-built_in">set</span>(observations)<br>    <span class="hljs-comment"># ^^ We assume each task inserts a different key above to</span><br>    <span class="hljs-comment"># avoid race conditions...</span><br>    futures = []<br>    retry_after = <span class="hljs-number">0.25</span>  <span class="hljs-comment"># Retry every quarter second</span><br>    <span class="hljs-keyword">with</span> ThreadPoolExecutor() <span class="hljs-keyword">as</span> executor:<br>        <span class="hljs-keyword">for</span> task <span class="hljs-keyword">in</span> tasks:<br>            deps = task[<span class="hljs-string">&quot;dependencies&quot;</span>]<br>            task_names[task[<span class="hljs-string">&quot;idx&quot;</span>]] = (<br>                task[<span class="hljs-string">&quot;tool&quot;</span>] <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(task[<span class="hljs-string">&quot;tool&quot;</span>], <span class="hljs-built_in">str</span>) <span class="hljs-keyword">else</span> task[<span class="hljs-string">&quot;tool&quot;</span>].name<br>            )<br>            args_for_tasks[task[<span class="hljs-string">&quot;idx&quot;</span>]] = (task[<span class="hljs-string">&quot;args&quot;</span>])<br>            <span class="hljs-keyword">if</span> (<br>                <span class="hljs-comment"># Depends on other tasks</span><br>                deps<br>                <span class="hljs-keyword">and</span> (<span class="hljs-built_in">any</span>([dep <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> observations <span class="hljs-keyword">for</span> dep <span class="hljs-keyword">in</span> deps]))<br>            ):<br>                futures.append(<br>                    executor.submit(<br>                        schedule_pending_task, task, observations, retry_after<br>                    )<br>                )<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-comment"># No deps or all deps satisfied</span><br>                <span class="hljs-comment"># can schedule now</span><br>                schedule_task.invoke(<span class="hljs-built_in">dict</span>(task=task, observations=observations))<br>                <span class="hljs-comment"># futures.append(executor.submit(schedule_task.invoke dict(task=task, observations=observations)))</span><br><br>        <span class="hljs-comment"># All tasks have been submitted or enqueued</span><br>        <span class="hljs-comment"># Wait for them to complete</span><br>        wait(futures)<br>    <span class="hljs-comment"># Convert observations to new tool messages to add to the state</span><br>    new_observations = &#123;<br>        k: (task_names[k], args_for_tasks[k], observations[k])<br>        <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">sorted</span>(observations.keys() - originals)<br>    &#125;<br>    tool_messages = [<br>        FunctionMessage(name=name, content=<span class="hljs-built_in">str</span>(obs), additional_kwargs=&#123;<span class="hljs-string">&quot;idx&quot;</span>: k, <span class="hljs-string">&#x27;args&#x27;</span>:task_args&#125;)<br>        <span class="hljs-keyword">for</span> k, (name, task_args, obs) <span class="hljs-keyword">in</span> new_observations.items()<br>    ]<br>    <span class="hljs-keyword">return</span> tool_messages<br><br><span class="hljs-keyword">import</span> itertools<br><br><br><span class="hljs-meta">@as_runnable</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">plan_and_schedule</span>(<span class="hljs-params">messages: <span class="hljs-type">List</span>[BaseMessage], config</span>):<br>    tasks = planner.stream(messages, config)<br>    <span class="hljs-comment"># Begin executing the planner immediately</span><br>    <span class="hljs-keyword">try</span>:<br>        tasks = itertools.chain([<span class="hljs-built_in">next</span>(tasks)], tasks)<br>    <span class="hljs-keyword">except</span> StopIteration:<br>        <span class="hljs-comment"># Handle the case where tasks is empty.</span><br>        tasks = <span class="hljs-built_in">iter</span>([])<br>    scheduled_tasks = schedule_tasks.invoke(<br>        &#123;<br>            <span class="hljs-string">&quot;messages&quot;</span>: messages,<br>            <span class="hljs-string">&quot;tasks&quot;</span>: tasks,<br>        &#125;,<br>        config,<br>    )<br>    <span class="hljs-keyword">return</span> scheduled_tasks<br></code></pre></td></tr></table></figure><p><strong>Joiner</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_core.pydantic_v1 <span class="hljs-keyword">import</span> BaseModel, Field<br><span class="hljs-keyword">from</span> langchain.chains.openai_functions <span class="hljs-keyword">import</span> create_structured_output_runnable<br><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> AIMessage<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FinalResponse</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;The final response/answer.&quot;&quot;&quot;</span><br><br>    response: <span class="hljs-built_in">str</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Replan</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):<br>    feedback: <span class="hljs-built_in">str</span> = Field(<br>        description=<span class="hljs-string">&quot;Analysis of the previous attempts and recommendations on what needs to be fixed.&quot;</span><br>    )<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">JoinOutputs</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Decide whether to replan or whether you can return the final response.&quot;&quot;&quot;</span><br><br>    thought: <span class="hljs-built_in">str</span> = Field(<br>        description=<span class="hljs-string">&quot;The chain of thought reasoning for the selected action&quot;</span><br>    )<br>    action: <span class="hljs-type">Union</span>[FinalResponse, Replan]<br><br><br>joiner_prompt = hub.pull(<span class="hljs-string">&quot;wfh/llm-compiler-joiner&quot;</span>).partial(<br>    examples=<span class="hljs-string">&quot;&quot;</span><br>)  <span class="hljs-comment"># You can optionally add examples</span><br>llm = ChatOpenAI(model=<span class="hljs-string">&quot;gpt-4-turbo&quot;</span>)<br><br>runnable = create_structured_output_runnable(JoinOutputs, llm, joiner_prompt)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_parse_joiner_output</span>(<span class="hljs-params">decision: JoinOutputs</span>) -&gt; <span class="hljs-type">List</span>[BaseMessage]:<br>    response = [AIMessage(content=<span class="hljs-string">f&quot;Thought: <span class="hljs-subst">&#123;decision.thought&#125;</span>&quot;</span>)]<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(decision.action, Replan):<br>        <span class="hljs-keyword">return</span> response + [<br>            SystemMessage(<br>                content=<span class="hljs-string">f&quot;Context from last attempt: <span class="hljs-subst">&#123;decision.action.feedback&#125;</span>&quot;</span><br>            )<br>        ]<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> response + [AIMessage(content=decision.action.response)]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">select_recent_messages</span>(<span class="hljs-params">messages: <span class="hljs-built_in">list</span></span>) -&gt; <span class="hljs-built_in">dict</span>:<br>    selected = []<br>    <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> messages[::-<span class="hljs-number">1</span>]:<br>        selected.append(msg)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(msg, HumanMessage):<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;messages&quot;</span>: selected[::-<span class="hljs-number">1</span>]&#125;<br><br><br>joiner = select_recent_messages | runnable | _parse_joiner_output<br></code></pre></td></tr></table></figure><p><strong>Graph</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> MessageGraph, END<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Dict</span><br><br>graph_builder = MessageGraph()<br><br><span class="hljs-comment"># 1.  Define vertices</span><br><span class="hljs-comment"># We defined plan_and_schedule above already</span><br><span class="hljs-comment"># Assign each node to a state variable to update</span><br>graph_builder.add_node(<span class="hljs-string">&quot;plan_and_schedule&quot;</span>, plan_and_schedule)<br>graph_builder.add_node(<span class="hljs-string">&quot;join&quot;</span>, joiner)<br><br><br><span class="hljs-comment">## Define edges</span><br>graph_builder.add_edge(<span class="hljs-string">&quot;plan_and_schedule&quot;</span>, <span class="hljs-string">&quot;join&quot;</span>)<br><br><span class="hljs-comment">### This condition determines looping logic</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">should_continue</span>(<span class="hljs-params">state: <span class="hljs-type">List</span>[BaseMessage]</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(state[-<span class="hljs-number">1</span>], AIMessage):<br>        <span class="hljs-keyword">return</span> END<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;plan_and_schedule&quot;</span><br><br><br>graph_builder.add_conditional_edges(<br>    <span class="hljs-string">&quot;join&quot;</span>,<br>    <span class="hljs-comment"># Next, we pass in the function that will determine which node is called next.</span><br>    should_continue,<br>)<br>graph_builder.set_entry_point(<span class="hljs-string">&quot;plan_and_schedule&quot;</span>)<br>chain = graph_builder.<span class="hljs-built_in">compile</span>()<br></code></pre></td></tr></table></figure><p><strong>简单问题</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> chain.stream([HumanMessage(content=<span class="hljs-string">&quot;What&#x27;s the GDP of New York?&quot;</span>)]):<br>    <span class="hljs-built_in">print</span>(step)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;---&quot;</span>)<br></code></pre></td></tr></table></figure><p>输出</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">&#123;&#x27;plan_and_schedule&#x27;: [FunctionMessage(content=&quot;&#123;&#x27;searchParameters&#x27;: &#123;&#x27;q&#x27;: &#x27;GDP of New York&#x27;, &#x27;gl&#x27;: &#x27;us&#x27;, &#x27;hl&#x27;: &#x27;en&#x27;, &#x27;type&#x27;: &#x27;search&#x27;, &#x27;num&#x27;: 1, &#x27;engine&#x27;: &#x27;google&#x27;&#125;, &#x27;organic&#x27;: [&#123;&#x27;title&#x27;: &#x27;Economy of New York (state) - Wikipedia&#x27;, &#x27;link&#x27;: &#x27;https://en.wikipedia.org/wiki/Economy_of_New_York_(state)&#x27;, &#x27;snippet&#x27;: &#x27;The economy of the State of New York is reflected in its gross state product in 2022 of $2.053 trillion, ranking third in size behind the larger states of ...&#x27;, &#x27;sitelinks&#x27;: [&#123;&#x27;title&#x27;: &#x27;New York City&#x27;, &#x27;link&#x27;: &#x27;https://en.wikipedia.org/wiki/Economy_of_New_York_(state)#New_York_City&#x27;&#125;, &#123;&#x27;title&#x27;: &#x27;Agriculture&#x27;, &#x27;link&#x27;: &#x27;https://en.wikipedia.org/wiki/Economy_of_New_York_(state)#Agriculture&#x27;&#125;, &#123;&#x27;title&#x27;: &#x27;Energy&#x27;, &#x27;link&#x27;: &#x27;https://en.wikipedia.org/wiki/Economy_of_New_York_(state)#Energy&#x27;&#125;], &#x27;position&#x27;: 1&#125;], &#x27;relatedSearches&#x27;: [&#123;&#x27;query&#x27;: &#x27;GDP of New York 2023&#x27;&#125;, &#123;&#x27;query&#x27;: &#x27;New York City GDP per capita&#x27;&#125;, &#123;&#x27;query&#x27;: &#x27;GDP of California&#x27;&#125;, &#123;&#x27;query&#x27;: &#x27;Gdp of new york 2021&#x27;&#125;, &#123;&#x27;query&#x27;: &#x27;GDP of Texas&#x27;&#125;, &#123;&#x27;query&#x27;: &#x27;New York City GDP 2022&#x27;&#125;, &#123;&#x27;query&#x27;: &#x27;Economy of New York City&#x27;&#125;, &#123;&#x27;query&#x27;: &#x27;New York GDP 2024&#x27;&#125;]&#125;&quot;, additional_kwargs=&#123;&#x27;idx&#x27;: 1, &#x27;args&#x27;: &#123;&#x27;query&#x27;: &#x27;GDP of New York&#x27;&#125;&#125;, name=&#x27;google_serper_results_json&#x27;, id=&#x27;4bcdf0bf-be99-4e51-9159-4c9a52485129&#x27;), FunctionMessage(content=&#x27;join&#x27;, additional_kwargs=&#123;&#x27;idx&#x27;: 2, &#x27;args&#x27;: ()&#125;, name=&#x27;join&#x27;, id=&#x27;491ca30e-5813-4f98-8ece-31052fc1b02f&#x27;)]&#125;<br>---<br>&#123;&#x27;join&#x27;: [AIMessage(content=&quot;Thought: The search results clearly state that the GDP of New York in 2022 was $2.053 trillion. This information is sufficient to provide a direct answer to the user&#x27;s query.&quot;, id=&#x27;32f5f56a-b717-4dda-b49a-1ded66c43681&#x27;), AIMessage(content=&#x27;The GDP of New York in 2022 was $2.053 trillion.&#x27;, id=&#x27;b154c632-f38b-4439-8dbb-5ab8b45b26b6&#x27;)]&#125;<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Final answer</span><br><span class="hljs-built_in">print</span>(step[<span class="hljs-string">&#x27;join&#x27;</span>][-<span class="hljs-number">1</span>].content)<br></code></pre></td></tr></table></figure><p>输出</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">The GDP of New York in 2022 was $2.053 trillion.<br></code></pre></td></tr></table></figure><p>LangSmith流程展示：</p><p><img src="/images/LangSmith_LLMComp1.png" srcset="/img/loading.gif" lazyload /></p><p><strong>多跳问题</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">steps = chain.stream(<br>    [<br>        HumanMessage(<br>            content=<span class="hljs-string">&quot;What&#x27;s the oldest parrot alive, and how much longer is that than the average?&quot;</span><br>        )<br>    ],<br>    &#123;<br>        <span class="hljs-string">&quot;recursion_limit&quot;</span>: <span class="hljs-number">100</span>,<br>    &#125;,<br>)<br><span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> steps:<br>    <span class="hljs-built_in">print</span>(step)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;---&quot;</span>)<br></code></pre></td></tr></table></figure><p>输出</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">&#123;&#x27;plan_and_schedule&#x27;: [FunctionMessage(content=&#x27;&#123;\&#x27;searchParameters\&#x27;: &#123;\&#x27;q\&#x27;: \&#x27;oldest parrot alive\&#x27;, \&#x27;gl\&#x27;: \&#x27;us\&#x27;, \&#x27;hl\&#x27;: \&#x27;en\&#x27;, \&#x27;type\&#x27;: \&#x27;search\&#x27;, \&#x27;num\&#x27;: 1, \&#x27;engine\&#x27;: \&#x27;google\&#x27;&#125;, \&#x27;organic\&#x27;: [&#123;\&#x27;title\&#x27;: \&#x27;3 Oldest Parrots in The World\&#x27;, \&#x27;link\&#x27;: \&#x27;https://www.oldest.org/animals/parrots/\&#x27;, \&#x27;snippet\&#x27;: &quot;Most birds of Poncho\&#x27;s breed live to be around 50 or 60, though some can reach 80 years of age with a good, healthy diet. Poncho, however, is 92, and is ...&quot;, \&#x27;position\&#x27;: 1&#125;], \&#x27;relatedSearches\&#x27;: [&#123;\&#x27;query\&#x27;: \&#x27;Top 10 oldest parrot alive\&#x27;&#125;, &#123;\&#x27;query\&#x27;: \&#x27;Parrot lifespan 140 years\&#x27;&#125;, &#123;\&#x27;query\&#x27;: \&#x27;Longest living parrot in captivity\&#x27;&#125;, &#123;\&#x27;query\&#x27;: \&#x27;Is Charlie the parrot still alive\&#x27;&#125;, &#123;\&#x27;query\&#x27;: \&#x27;Oldest African Grey parrot\&#x27;&#125;, &#123;\&#x27;query\&#x27;: \&#x27;Oldest bird\&#x27;&#125;, &#123;\&#x27;query\&#x27;: \&#x27;100 year old parrot\&#x27;&#125;, &#123;\&#x27;query\&#x27;: \&#x27;Cocky Bennett the cockatoo\&#x27;&#125;]&#125;&#x27;, additional_kwargs=&#123;&#x27;idx&#x27;: 1, &#x27;args&#x27;: &#123;&#x27;query&#x27;: &#x27;oldest parrot alive&#x27;&#125;&#125;, name=&#x27;google_serper_results_json&#x27;, id=&#x27;abab82fe-4477-4029-aff6-832bdbc6fea4&#x27;), FunctionMessage(content=&quot;&#123;&#x27;searchParameters&#x27;: &#123;&#x27;q&#x27;: &#x27;average lifespan of a parrot&#x27;, &#x27;gl&#x27;: &#x27;us&#x27;, &#x27;hl&#x27;: &#x27;en&#x27;, &#x27;type&#x27;: &#x27;search&#x27;, &#x27;num&#x27;: 1, &#x27;engine&#x27;: &#x27;google&#x27;&#125;, &#x27;knowledgeGraph&#x27;: &#123;&#x27;title&#x27;: &#x27;Parrots&#x27;, &#x27;type&#x27;: &#x27;Birds&#x27;, &#x27;imageUrl&#x27;: &#x27;https://encrypted-tbn0.gstatic.com/licensed-image?q=tbn:ANd9GcRldZn14udjcIcuAOvalFdHTcLCTmyYQWq6faVtdOvqc7Zo5cYp1YAQRB2DlNeWDbCRLEd0&amp;s=19&#x27;, &#x27;description&#x27;: &#x27;Parrots, also known as psittacines, are birds with a strong curved beak, upright stance, and clawed feet. They are conformed by four families that contain roughly 410 species in 101 genera, found mostly in tropical and subtropical regions.&#x27;, &#x27;descriptionSource&#x27;: &#x27;Wikipedia&#x27;, &#x27;descriptionLink&#x27;: &#x27;https://en.wikipedia.org/wiki/Parrot&#x27;, &#x27;attributes&#x27;: &#123;&#x27;Lifespan&#x27;: &#x27;Cockatoos: 40 – 60\\xa0years, Kākāpō: 60\\xa0years, and Hyacinth macaw: 50\\xa0years&#x27;, &#x27;Scientific name&#x27;: &#x27;Psittaciformes&#x27;, &#x27;Clade&#x27;: &#x27;Psittacopasseres&#x27;, &#x27;Class&#x27;: &#x27;Aves&#x27;, &#x27;Domain&#x27;: &#x27;Eukaryota&#x27;, &#x27;Kingdom&#x27;: &#x27;Animalia&#x27;&#125;&#125;, &#x27;organic&#x27;: [&#123;&#x27;title&#x27;: &#x27;How Long Do Parrots Live? - PetMD&#x27;, &#x27;link&#x27;: &#x27;https://www.petmd.com/bird/how-long-do-parrots-live&#x27;, &#x27;snippet&#x27;: &#x27;Some pets, such as tortoises and parrots, may live for over 50 years. Because they are a lifelong commitment, lawyers often urge pet parents to ...&#x27;, &#x27;date&#x27;: &#x27;Jul 19, 2023&#x27;, &#x27;sitelinks&#x27;: [&#123;&#x27;title&#x27;: &#x27;Parakeet Care Sheet&#x27;, &#x27;link&#x27;: &#x27;https://www.petmd.com/bird/parakeet-care-sheet&#x27;&#125;, &#123;&#x27;title&#x27;: &#x27;Cockatiel Care Sheet&#x27;, &#x27;link&#x27;: &#x27;https://www.petmd.com/bird/cockatiel-care-sheet&#x27;&#125;, &#123;&#x27;title&#x27;: &#x27;Budgie Care Sheet&#x27;, &#x27;link&#x27;: &#x27;https://www.petmd.com/bird/budgie-care-sheet&#x27;&#125;], &#x27;position&#x27;: 1&#125;], &#x27;relatedSearches&#x27;: [&#123;&#x27;query&#x27;: &#x27;Parrot lifespan 140 years&#x27;&#125;, &#123;&#x27;query&#x27;: &#x27;Average lifespan of a parrot in the wild&#x27;&#125;, &#123;&#x27;query&#x27;: &#x27;Average lifespan of a parrot in captivity&#x27;&#125;, &#123;&#x27;query&#x27;: &#x27;Green parrot lifespan&#x27;&#125;, &#123;&#x27;query&#x27;: &#x27;Indian parrot lifespan 140 years&#x27;&#125;, &#123;&#x27;query&#x27;: &#x27;Talking parrot lifespan&#x27;&#125;, &#123;&#x27;query&#x27;: &#x27;African Grey parrot lifespan&#x27;&#125;, &#123;&#x27;query&#x27;: &#x27;Macaw parrot lifespan&#x27;&#125;]&#125;&quot;, additional_kwargs=&#123;&#x27;idx&#x27;: 2, &#x27;args&#x27;: &#123;&#x27;query&#x27;: &#x27;average lifespan of a parrot&#x27;&#125;&#125;, name=&#x27;google_serper_results_json&#x27;, id=&#x27;b4a0cdb9-284c-4738-8043-f482aab3fd5f&#x27;), FunctionMessage(content=&#x27;join&#x27;, additional_kwargs=&#123;&#x27;idx&#x27;: 3, &#x27;args&#x27;: ()&#125;, name=&#x27;join&#x27;, id=&#x27;47c9e6e0-93e2-448b-bb9f-b810e8e835a6&#x27;)]&#125;<br>---<br>&#123;&#x27;join&#x27;: [AIMessage(content=&quot;Thought: The search results indicate that the oldest parrot alive is named Poncho and is 92 years old. The average lifespan of parrots varies by type, but for many common types it ranges between 40 to 60 years. Using the upper range of 60 years for comparison, Poncho&#x27;s age of 92 is 32 years longer than the average lifespan of his breed.&quot;, id=&#x27;8e65ac41-4b35-465d-af40-f97158e90fd5&#x27;), AIMessage(content=&#x27;The oldest parrot alive is named Poncho, who is 92 years old. This is 32 years longer than the upper average lifespan of his breed, which is about 60 years.&#x27;, id=&#x27;c02330b3-b772-4a99-bce3-4596963c07f2&#x27;)]&#125;<br>---<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Final answer</span><br><span class="hljs-built_in">print</span>(step[<span class="hljs-string">&#x27;join&#x27;</span>][-<span class="hljs-number">1</span>].content)<br></code></pre></td></tr></table></figure><p>输出</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">The oldest parrot alive is named Poncho, who is 92 years old. This is 32 years longer than the upper average lifespan of his breed, which is about 60 years.<br></code></pre></td></tr></table></figure><p>LangSmith流程展示：</p><p><img src="/images/LangSmith_LLMComp2.png" srcset="/img/loading.gif" lazyload /></p><p><strong>多步骤数学问题</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> chain.stream(<br>    [<br>        HumanMessage(<br>            content=<span class="hljs-string">&quot;What&#x27;s ((3*(4+5)/0.5)+3245) + 8? What&#x27;s 32/4.23? What&#x27;s the sum of those two values?&quot;</span><br>        )<br>    ]<br>):<br>    <span class="hljs-built_in">print</span>(step)<br></code></pre></td></tr></table></figure><p>输出</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">&#123;&#x27;plan_and_schedule&#x27;: [FunctionMessage(content=&#x27;3307.0&#x27;, additional_kwargs=&#123;&#x27;idx&#x27;: 1, &#x27;args&#x27;: &#123;&#x27;problem&#x27;: &#x27;((3*(4+5)/0.5)+3245) + 8&#x27;&#125;&#125;, name=&#x27;math&#x27;, id=&#x27;a8e6d377-d660-42d2-8cd4-85d9f98ffe9a&#x27;), FunctionMessage(content=&#x27;7.565011820330969&#x27;, additional_kwargs=&#123;&#x27;idx&#x27;: 2, &#x27;args&#x27;: &#123;&#x27;problem&#x27;: &#x27;32/4.23&#x27;&#125;&#125;, name=&#x27;math&#x27;, id=&#x27;101c6d4e-4f40-49d6-91d9-d926e05b2825&#x27;), FunctionMessage(content=&#x27;3314.565011820331&#x27;, additional_kwargs=&#123;&#x27;idx&#x27;: 3, &#x27;args&#x27;: &#123;&#x27;problem&#x27;: &#x27;$1 + $2&#x27;, &#x27;context&#x27;: [&#x27;$1&#x27;, &#x27;$2&#x27;]&#125;&#125;, name=&#x27;math&#x27;, id=&#x27;9eee847c-9be2-461d-9210-8612a34cff95&#x27;), FunctionMessage(content=&#x27;join&#x27;, additional_kwargs=&#123;&#x27;idx&#x27;: 4, &#x27;args&#x27;: ()&#125;, name=&#x27;join&#x27;, id=&#x27;611383f1-05de-40db-acf5-e996153ce6ad&#x27;)]&#125;<br>&#123;&#x27;join&#x27;: [AIMessage(content=&quot;Thought: The calculations were performed correctly. The first value calculated was 3307.0, and the second was 7.565011820330969. The sum of these two values is 3314.565011820331, which answers the user&#x27;s question about the sum.&quot;, id=&#x27;c7d48b7a-5033-47d4-b722-b2527a994c92&#x27;), AIMessage(content=&#x27;The first value is 3307.0, the second value is approximately 7.57, and their sum is approximately 3314.57.&#x27;, id=&#x27;3f20fd0a-3e1b-4a0a-8164-f48d350fda0d&#x27;)]&#125;<br>---<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Final answer</span><br><span class="hljs-built_in">print</span>(step[<span class="hljs-string">&#x27;join&#x27;</span>][-<span class="hljs-number">1</span>].content)<br></code></pre></td></tr></table></figure><p>输出</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">The first value is 3307.0, the second value is approximately 7.57, and their sum is approximately 3314.57.<br></code></pre></td></tr></table></figure><p>LangSmith流程展示：</p><p><img src="/images/LangSmith_LLMComp3.png" srcset="/img/loading.gif" lazyload /></p>
        </div>
      </div>
    </div>
<h3 id="结论">结论</h3>
<ul>
<li>这三种Agent架构是<code>Plan-and-Execute</code>设计模式的典型代表，将LLM驱动的<code>Planner</code>与工具执行运行时分离。</li>
<li>如果应用程序需要多次工具调用或API调用，这些方法可以减少返回最终结果所需的时间，并通过减少对更强大的LLM的调用频率来帮助节省成本。</li>
</ul>
<h2 id="官方资源">官方资源</h2>
<p>代码示例更详细说明：</p>
<ul>
<li><a
target="_blank" rel="noopener" href="https://github.com/langchain-ai/langgraph/blob/main/examples/plan-and-execute/plan-and-execute.ipynb">Plan-and-execute</a></li>
<li><a
target="_blank" rel="noopener" href="https://github.com/langchain-ai/langgraph/blob/main/examples/rewoo/rewoo.ipynb">ReWOO</a></li>
<li><a
target="_blank" rel="noopener" href="https://github.com/langchain-ai/langgraph/blob/main/examples/llm-compiler/LLMCompiler.ipynb">LLMCompiler</a></li>
<li><a
target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=uRya4zRrRx4&amp;list=PLfaIDFEXuae16n2TWUkKq5PgJ0w6Pkwtg&amp;index=13">官方YouTube</a></li>
<li><a
target="_blank" rel="noopener" href="https://blog.langchain.dev/planning-agents/">官方Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1vJ4m1s7Zn/">B站视频</a>
<section class="footnotes">
<div class="footnote-list">
<ol>
<li>
<span id="fn:1" class="footnote-text"><span><a
target="_blank" rel="noopener" href="https://github.com/SqueezeAILab/LLMCompiler/blob/main/src/llm_compiler/output_parser.py"
class="uri">https://github.com/SqueezeAILab/LLMCompiler/blob/main/src/llm_compiler/output_parser.py</a>
<a href="#fnref:1" rev="footnote" class="footnote-backref">
↩︎</a></span></span>
</li>
</ol>
</div>
</section></li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/LangGraph/" class="category-chain-item">LangGraph</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/LLM/" class="print-no-link">#LLM</a>
      
        <a href="/tags/LLM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="print-no-link">#LLM学习笔记</a>
      
        <a href="/tags/Agent/" class="print-no-link">#Agent</a>
      
        <a href="/tags/LangGraph/" class="print-no-link">#LangGraph</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>LangGraph(五)——Plan-and-Execute Agents</div>
      <div>https://mztchaoqun.com.cn/posts/D36_LangGraph_Plan_And_Execute/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>mztchaoqun</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年9月7日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="SA - 相同方式共享">
                    <i class="iconfont icon-cc-sa"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/posts/D37_Refection_Agents/" title="LangGraph(六)——Reflection Agents">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">LangGraph(六)——Reflection Agents</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/posts/D35_LangGraph_Self_Reflective_RAG/" title="LangGraph(四)——Self-Reflective RAG">
                        <span class="hidden-mobile">LangGraph(四)——Self-Reflective RAG</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <!-- <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> --> <div class="flex flex-auto justify-center [&amp;>*]:px-[16px] [&amp;>a]:no-underline  mb-[8px]"><a target="_blank" class="flex items-center text-[#A1A1A1] hover:text-white " href="https://www.beian.gov.cn/portal/registerSystemInfo?recordcode=51015602000856"><img alt="川公网安备" fetchpriority="high" width="20" height="20" decoding="async" data-nimg="1" class="mr-[6px]" src="/images/ga.png" srcset="/img/loading.gif" lazyload style="color: transparent;">&nbsp;川公网安备&nbsp;51015602000856号</a>&emsp;<a target="_blank" class="text-[#A1A1A1] hover:text-white " href="https://beian.miit.gov.cn/">蜀ICP备2024061486号-1</a></div> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
